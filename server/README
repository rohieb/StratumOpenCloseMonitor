This directory contains the server part of the Stratum 0 Open/Close Monitor.

== Depencendies ==
* Supybot >= 0.83 (http://sourceforge.net/projects/supybot/)
* nginx
* sudo
* cron
* nmap >= 6.00

On a recent Debian system (tested on wheezy) do the following:
# apt-get install supybot nginx-light sudo cron nmap

== Installation ==
These steps were tested on a Debian wheezy system. If you are using a different
distribution, you may have to change the paths accordingly to your system, and
also edit the hard-coded paths to the files mentioned at the beginning of
supybot/StratumMonitor/plugin.py.

Here is what I did, on my system, as root:

1. Add a separate user and group to run Supybot:

# groupadd stratummonitor
# useradd -rm -s /bin/false -g stratummonitor ircbot

2. Add a site to the nginx configuration and allow the ircbot user to change it.
   The nginx config file will be generated by the Supybot plugin from a template.
	 If you want to change the generated config, change the template at the
	 beginning of supybot/StratumMonitor/plugin.py.

# mkdir -p /etc/nginx/sites-enabled/     # unless it already exists...
# rm -f /etc/nginx/sites-enabled/default # default config is not needed
# touch /etc/nginx/sites-enabled/status.stratum0.org
# chgrp stratummonitor /etc/nginx/sites-enabled/status.stratum0.org
# chmod g+rw /etc/nginx/sites-enabled/status.stratum0.org

3. Copy (or link) the contents of www/ to /srv/status.stratum0.org. This will be
   the WWW root for the generated nginx configuration. Again, if you want to
	 change that location, change the template at the beginning of
	 supybot/StratumMonitor/plugin.py.

# mkdir -p /srv/status.stratum0.org
# cp www/* /srv/status.stratum0.org
 -- or, instead of mkdir and cp, just link to your cloned repository --
# ln -s ~/StratumOpenCloseMonitor/server/www/ /srv/status.stratum0.org
 -- then, for both cases --
# chgrp stratummonitor /srv/status.stratum0.org
# chmod g+rws /srv/status.stratum0.org

4. Allow the ircbot user to restart nginx. You can use the sudoers.d template
   from sudoers.d/nginx-reload and copy it to /etc/sudoers.d/

# cp sudoers.d/nginx-reload /etc/sudoers.d/
# chmod 440 /etc/sudoers.d/nginx-reload
# chown root:root /etc/sudoers.d/nginx-reload

5. Start the Supybot instance from supybot/supybot.conf.example. You can also
   use this file as a template. By default, the Supybot instance connects to
   irc.freenode.net, takes the nick StratumGuardian and joins the channel
	 #stratum0. In any case, you probably want to change the NickServ password
	 (search for the string {{{PASSWORD}}} in the example configuration).
	 Also note that by default, Supybot uses /home/ircbot for its root folder.

# cp -R supybot/ /home/ircbot/
 -- or, instead of cp, just link to your cloned repository --
# ln -s ~/StratumOpenCloseMonitor/server/supybot/ /home/ircbot/supybot
 -- then, for both cases --
# chown -R ircbot:stratummonitor /home/ircbot/supybot/
# sudo -u ircbot supybot supybot/supybot.conf.example &

Supybot will write its output to supybot/logs/messages.log.

6. Create a crontab entry so Supybot is started at reboot. You can use the
   template in cron.d/stratummonitor.

# cp cron.d/stratummonitor /etc/cron.d/stratummonitor
 -- or, instead of cp, just link to your cloned repository --
# ln ~/StratumOpenCloseMonitor/server/cron.d/stratummonitor /etc/cron.d/stratummonitor
 -- then, for both cases --
# chown root:root /etc/cron.d/stratummonitor

7. For the detection of present entities in the hackerspace, create the files
   /etc/stratummonitor/known-macs and /etc/stratummonitor/known-mdns, and fill
   them with a mapping of MAC addresses resp. mDNS hostnames (without the domain
   postfix) to IRC nick names. The file must contain one mapping per line, each
   line consists of a MAC address or hostname, the '=>' string and the nick name
   of the corresponding user. A sample of this files looks as following:

   /etc/stratummonitor/known-macs:
     08:24:15:db:2b:56 => AcidBurn
     00:10:35:bc:a5:11 => ZeroCool
     DE:AD:BE:EF:13:37 => JRandomHacker

   /etc/stratummonitor/known-mdns:
     r2d2 => ZeroCool
     c3po => JRandomHacker

   This file is read by Supybot, and every user who is currently present on the
   LAN will be given voice in the IRC channel.

== Usage ==
The space status can be set with the commands 'offen' and 'zu'. There are also
additional aliases defined: 'auf' and 'open' are aliases for 'offen', and
'close' and 'closed' are aliases for 'zu'.

To see the currently present (and known) entities on the LAN, use the command
'weristda'.

The default supybot configuration defines two command prefixes, 'sudo' and
'mach', so you can use 'sudo open' or 'mach auf' to set the status to open, and
'sudo close' or 'mach zu' to set the status to closed.  

